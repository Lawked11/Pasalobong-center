<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Orders - Admin</title>
  <link rel="stylesheet" href="admin_dashboard.css">
  <link rel="stylesheet" href="orders.css">
  <style>
    .status-dropdown {
      padding: 6px 12px;
      border-radius: 12px;
      border: 2px solid;
      font-weight: 600;
      text-transform: capitalize;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .status-dropdown:hover {
      opacity: 0.8;
    }
    .status-pending {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }
    .status-processing {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
    .status-shipped {
      background: #ede9fe;
      border-color: #8b5cf6;
      color: #5b21b6;
    }
    .status-delivered {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }
    .status-cancelled {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <button id="burgerBtn" class="burger" aria-label="Open menu" aria-expanded="false" aria-controls="sideDrawer">
        <span></span><span></span><span></span>
      </button>
      <div class="navbar-left">
        <span class="admin-title">ORDER MONITORING</span>
      </div>
      <div class="navbar-right">
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>
  <aside id="sideDrawer" class="side-drawer" aria-hidden="true">
    <div class="drawer-header">Menu</div>
    <ul class="drawer-list">
      <li><a href="admin_dashboard.html">Add Products</a></li>
      <li><a href="inventory.html">Product Inventory & Monitoring</a></li>
      <li><a href="users.html">User Accounts Management</a></li>
      <li><a href="orders.html">Order Monitoring</a></li>
    </ul>
  </aside>
  <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>
  <main>
    <section class="dashboard-section">
      <div class="monitor-section">
        <h2>Order Monitoring</h2>
        
        <!-- Filter Section -->
        <div class="filter-section" style="margin-bottom: 20px;">
          <label for="statusFilter" style="margin-right: 10px; font-weight: 600;">Filter by Status:</label>
          <select id="statusFilter" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd;">
            <option value="all">All Orders</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <div id="loadingOrders" style="text-align: center; padding: 40px;">
          <p>Loading orders...</p>
        </div>

        <div id="noOrders" style="display: none; text-align: center; padding: 40px;">
          <p>No orders found.</p>
        </div>

        <table class="orders-table" id="ordersTable" style="display: none;">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>User Email</th>
              <th>Items</th>
              <th>Shipping Info</th>
              <th>Total</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <!-- Orders will be loaded here -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="logout-modal">
    <div class="logout-modal-content">
      <h3>Confirm Delete</h3>
      <p id="deleteModalMessage">Are you sure you want to delete this order?</p>
      <div class="logout-modal-actions">
        <button id="confirmDeleteBtn" class="modal-btn logout-confirm">Delete</button>
        <button id="cancelDeleteBtn" class="modal-btn logout-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to logout?</p>
      <div class="logout-modal-actions">
        <button id="confirmLogoutBtn" class="modal-btn logout-confirm">Logout</button>
        <button id="cancelLogoutBtn" class="modal-btn logout-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    let currentUser = null;
    let ordersUnsubscribe = null;
    let allOrders = [];
    let currentOrderId = null;

    // Check authentication and admin status
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const adminDoc = await getDoc(doc(db, 'admins', user.uid));
        if (adminDoc.exists() && adminDoc.data().role === 'admin') {
          currentUser = user;
          loadOrders();
        } else {
          alert('Access denied. Admin only.');
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });

    function loadOrders() {
      if (ordersUnsubscribe) {
        ordersUnsubscribe();
      }

      const ordersRef = collection(db, 'orders');
      const q = query(ordersRef, orderBy('createdAt', 'desc'));

      ordersUnsubscribe = onSnapshot(q, (snapshot) => {
        allOrders = [];
        snapshot.forEach((doc) => {
          allOrders.push({ id: doc.id, ...doc.data() });
        });
        renderOrders(allOrders);
      });
    }

    function renderOrders(orders) {
      const tableBody = document.getElementById('ordersTableBody');
      const loadingDiv = document.getElementById('loadingOrders');
      const noOrdersDiv = document.getElementById('noOrders');
      const table = document.getElementById('ordersTable');

      loadingDiv.style.display = 'none';

      if (orders.length === 0) {
        noOrdersDiv.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      noOrdersDiv.style.display = 'none';
      table.style.display = 'table';

      let html = '';
      orders.forEach(order => {
        const orderDate = order.createdAt ? 
          new Date(order.createdAt.seconds * 1000).toLocaleString() : 
          'N/A';

        const itemsList = order.items.map(item => 
          `${item.quantity}x ${item.name}`
        ).join('<br>');

        const shippingInfo = order.shippingInfo ? 
          `${order.shippingInfo.name}<br>${order.shippingInfo.phone}<br>${order.shippingInfo.address}` : 
          'N/A';

        const statusClass = `status-${order.status}`;

        html += `
          <tr>
            <td style="font-family: monospace; font-size: 12px;">${order.id.substring(0, 8)}</td>
            <td>${order.customerEmail || 'N/A'}</td>
            <td>${itemsList}</td>
            <td style="font-size: 12px;">${shippingInfo}</td>
            <td style="font-weight: 600;">₱${order.total.toFixed(2)}</td>
            <td>
              <select class="status-dropdown ${statusClass}" data-id="${order.id}">
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </td>
            <td style="font-size: 12px;">${orderDate}</td>
            <td>
              <button class="table-btn delete-order-btn" data-id="${order.id}">
                Delete
              </button>
            </td>
          </tr>
        `;
      });

      tableBody.innerHTML = html;

      // Attach event listeners for status dropdowns
      document.querySelectorAll('.status-dropdown').forEach(select => {
        select.onchange = async (e) => {
          const orderId = e.target.dataset.id;
          const newStatus = e.target.value;
          await updateOrderStatus(orderId, newStatus, e.target);
        };
      });

      // Attach event listeners for delete buttons
      document.querySelectorAll('.delete-order-btn').forEach(btn => {
        btn.onclick = () => openDeleteModal(btn.dataset.id);
      });
    }

    async function updateOrderStatus(orderId, newStatus, selectElement) {
      const previousStatus = selectElement.className.match(/status-(\w+)/)[1];
      
      // Update the class immediately for visual feedback
      selectElement.className = `status-dropdown status-${newStatus}`;

      try {
        const orderRef = doc(db, 'orders', orderId);
        await updateDoc(orderRef, {
          status: newStatus,
          updatedAt: new Date()
        });

        // Show success message
        const originalText = selectElement.options[selectElement.selectedIndex].text;
        selectElement.options[selectElement.selectedIndex].text = '✓ Updated!';
        setTimeout(() => {
          selectElement.options[selectElement.selectedIndex].text = originalText;
        }, 1500);

      } catch (error) {
        console.error('Error updating order status:', error);
        alert('Error updating order status. Please try again.');
        
        // Revert the visual change
        selectElement.className = `status-dropdown status-${previousStatus}`;
        selectElement.value = previousStatus;
      }
    }

    function openDeleteModal(orderId) {
      currentOrderId = orderId;
      document.getElementById('deleteModalMessage').textContent = 
        `Are you sure you want to delete order ${orderId.substring(0, 8)}? This action cannot be undone.`;
      document.getElementById('deleteModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('open');
      document.body.style.overflow = '';
      currentOrderId = null;
    }

    async function deleteOrder() {
      if (!currentOrderId) return;

      try {
        const orderRef = doc(db, 'orders', currentOrderId);
        await deleteDoc(orderRef);

        alert('Order deleted successfully!');
        closeDeleteModal();
      } catch (error) {
        console.error('Error deleting order:', error);
        alert('Error deleting order. Please try again.');
      }
    }

    // Filter orders by status
    document.getElementById('statusFilter').onchange = (e) => {
      const filterValue = e.target.value;
      
      if (filterValue === 'all') {
        renderOrders(allOrders);
      } else {
        const filtered = allOrders.filter(order => order.status === filterValue);
        renderOrders(filtered);
      }
    };

    // Delete modal events
    document.getElementById('confirmDeleteBtn').onclick = deleteOrder;
    document.getElementById('cancelDeleteBtn').onclick = closeDeleteModal;
    document.getElementById('deleteModal').onclick = (e) => {
      if (e.target === document.getElementById('deleteModal')) closeDeleteModal();
    };

    // Logout functionality
    const logoutModal = document.getElementById('logoutModal');
    const logoutBtn = document.getElementById('logoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');

    logoutBtn.onclick = () => {
      logoutModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    };

    cancelLogoutBtn.onclick = () => {
      logoutModal.classList.remove('open');
      document.body.style.overflow = '';
    };

    logoutModal.onclick = (e) => {
      if (e.target === logoutModal) {
        logoutModal.classList.remove('open');
        document.body.style.overflow = '';
      }
    };

    confirmLogoutBtn.onclick = async () => {
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Error logging out:', error);
        alert('Error logging out. Please try again.');
      }
    };

    // Burger menu
    const burgerBtn = document.getElementById('burgerBtn');
    const sideDrawer = document.getElementById('sideDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');

    function openDrawer() {
      sideDrawer.classList.add('open');
      drawerBackdrop.hidden = false;
      document.body.style.overflow = 'hidden';
      burgerBtn.setAttribute('aria-expanded', 'true');
      sideDrawer.setAttribute('aria-hidden', 'false');
    }

    function closeDrawer() {
      sideDrawer.classList.remove('open');
      drawerBackdrop.hidden = true;
      document.body.style.overflow = '';
      burgerBtn.setAttribute('aria-expanded', 'false');
      sideDrawer.setAttribute('aria-hidden', 'true');
    }

    burgerBtn.onclick = openDrawer;
    drawerBackdrop.onclick = closeDrawer;
    sideDrawer.addEventListener('click', e => {
      if (e.target.tagName === 'A') closeDrawer();
    });
  </script>
</body>
</html>