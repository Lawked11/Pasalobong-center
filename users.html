<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Users - Admin</title>
  <link rel="stylesheet" href="users.css">
</head>

<body>
  <header>
    <nav class="navbar">
      <button id="burgerBtn" class="burger" aria-label="Open menu" aria-expanded="false" aria-controls="sideDrawer">
        <span></span><span></span><span></span>
      </button>
      <div class="navbar-left">
        <span class="admin-title">USER ACCOUNTS</span>
      </div>
      <div class="navbar-right">
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>
  <aside id="sideDrawer" class="side-drawer" aria-hidden="true">
    <div class="drawer-header">Menu</div>
    <ul class="drawer-list">
      <li><a href="admin_dashboard.html">Add Products</a></li>
      <li><a href="inventory.html">Product Inventory & Monitoring</a></li>
      <li><a href="users.html">User Accounts Management</a></li>
      <li><a href="orders.html">Order Monitoring</a></li>
    </ul>
  </aside>
  <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>
  <main>
    <section class="dashboard-section">
      <div class="table-section">
        <h2>User Accounts Management</h2>
        <div id="loadingMessage" class="loading">Loading users...</div>
        <table class="user-table" id="userTable" style="display:none;">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Registered</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to logout?</p>
      <div class="logout-modal-actions">
        <button id="confirmLogoutBtn" class="modal-btn logout-confirm">Logout</button>
        <button id="cancelLogoutBtn" class="modal-btn logout-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD373HsUJ7jJsDZEKZQzaHGPAJglizaZY4",
      authDomain: "pasalobong-486c3.firebaseapp.com",
      projectId: "pasalobong-486c3",
      storageBucket: "pasalobong-486c3.firebasestorage.app",
      messagingSenderId: "157431097657",
      appId: "1:157431097657:web:dc8afc6e6d18ada4a120e8",
      measurementId: "G-Y13929E4XY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Logout modal logic
    const logoutModal = document.getElementById('logoutModal');
    const logoutBtn = document.getElementById('logoutBtn');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    
    logoutBtn.onclick = () => { 
      logoutModal.classList.add('open'); 
      document.body.style.overflow = 'hidden'; 
    };
    
    cancelLogoutBtn.onclick = () => { 
      logoutModal.classList.remove('open'); 
      document.body.style.overflow = ''; 
    };
    
    logoutModal.onclick = (e) => { 
      if (e.target === logoutModal) { 
        logoutModal.classList.remove('open'); 
        document.body.style.overflow = ''; 
      } 
    };
    
    confirmLogoutBtn.onclick = async () => {
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error logging out. Please try again.');
      }
    };

    // Drawer logic
    const burgerBtn = document.getElementById('burgerBtn');
    const sideDrawer = document.getElementById('sideDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    
    function openDrawer() { 
      sideDrawer.classList.add('open'); 
      drawerBackdrop.hidden = false; 
      document.body.style.overflow = 'hidden'; 
      burgerBtn.setAttribute('aria-expanded', 'true'); 
      sideDrawer.setAttribute('aria-hidden', 'false'); 
    }
    
    function closeDrawer() { 
      sideDrawer.classList.remove('open'); 
      drawerBackdrop.hidden = true; 
      document.body.style.overflow = ''; 
      burgerBtn.setAttribute('aria-expanded', 'false'); 
      sideDrawer.setAttribute('aria-hidden', 'true'); 
    }
    
    burgerBtn.onclick = openDrawer; 
    drawerBackdrop.onclick = closeDrawer; 
    sideDrawer.addEventListener('click', e => { 
      if (e.target.tagName === 'A') closeDrawer(); 
    });

    // Load all users (both customers and admins)
    async function loadUsers() {
      const loadingMessage = document.getElementById('loadingMessage');
      const userTable = document.getElementById('userTable');
      const userTableBody = document.getElementById('userTableBody');
      
      try {
        const allUsers = [];
        
        // Fetch customers
        const customersSnapshot = await getDocs(collection(db, 'customers'));
        customersSnapshot.forEach(doc => {
          allUsers.push({
            id: doc.id,
            ...doc.data(),
            collection: 'customers'
          });
        });
        
        // Fetch admins
        const adminsSnapshot = await getDocs(collection(db, 'admins'));
        adminsSnapshot.forEach(doc => {
          allUsers.push({
            id: doc.id,
            ...doc.data(),
            collection: 'admins'
          });
        });
        
        // Clear table body
        userTableBody.innerHTML = '';
        
        if (allUsers.length === 0) {
          loadingMessage.textContent = 'No users found.';
          return;
        }
        
        // Sort by creation date (newest first)
        allUsers.sort((a, b) => {
          const dateA = a.createdAt?.toDate() || new Date(0);
          const dateB = b.createdAt?.toDate() || new Date(0);
          return dateB - dateA;
        });
        
        // Populate table
        allUsers.forEach(user => {
          const row = document.createElement('tr');
          const formattedDate = user.createdAt 
            ? user.createdAt.toDate().toISOString().split('T')[0]
            : 'N/A';
          const status = user.isActive ? 'Active' : 'Inactive';
          const role = user.role === 'admin' ? 'Admin' : 'Customer';
          const isCurrentAdmin = user.role === 'admin' && auth.currentUser?.uid === user.id;
          
          row.innerHTML = `
            <td>${user.id.substring(0, 8).toUpperCase()}</td>
            <td>${user.email || 'N/A'}</td>
            <td>${role}</td>
            <td>${status}</td>
            <td>${formattedDate}</td>
            <td>
              <div class="action-btn-group">
                <button class="table-btn edit-user-btn" data-id="${user.id}" data-collection="${user.collection}">Edit</button>
                <button class="table-btn status-user-btn" data-id="${user.id}" data-collection="${user.collection}" data-status="${user.isActive}" ${isCurrentAdmin ? 'disabled' : ''}>
                  ${user.isActive ? 'Deactivate' : 'Activate'}
                </button>
                <button class="table-btn delete-user-btn" data-id="${user.id}" data-collection="${user.collection}" ${isCurrentAdmin ? 'disabled' : ''}>Delete</button>
              </div>
            </td>
          `;
          userTableBody.appendChild(row);
        });
        
        // Show table, hide loading
        loadingMessage.style.display = 'none';
        userTable.style.display = 'table';
        
        // Add event listeners
        attachButtonListeners();
        
      } catch (error) {
        console.error('Error loading users:', error);
        loadingMessage.textContent = 'Error loading users. Please check console.';
      }
    }

    // Attach event listeners to buttons
    function attachButtonListeners() {
      document.querySelectorAll('.status-user-btn').forEach(btn => {
        btn.onclick = async () => {
          if (btn.disabled) return;
          
          const userId = btn.dataset.id;
          const collectionName = btn.dataset.collection;
          const currentStatus = btn.dataset.status === 'true';
          
          if (confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this user?`)) {
            try {
              const userRef = doc(db, collectionName, userId);
              await updateDoc(userRef, {
                isActive: !currentStatus,
                updatedAt: new Date()
              });
              alert('User status updated successfully!');
              loadUsers();
            } catch (error) {
              console.error('Error updating user status:', error);
              alert('Error updating user status. Check console.');
            }
          }
        };
      });

      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.onclick = async () => {
          if (btn.disabled) return;
          
          const userId = btn.dataset.id;
          const collectionName = btn.dataset.collection;
          
          if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            try {
              const userRef = doc(db, collectionName, userId);
              await deleteDoc(userRef);
              alert('User deleted successfully!');
              loadUsers();
            } catch (error) {
              console.error('Error deleting user:', error);
              alert('Error deleting user. Check console.');
            }
          }
        };
      });

      document.querySelectorAll('.edit-user-btn').forEach(btn => {
        btn.onclick = () => {
          alert('Edit functionality - implement modal or redirect to edit page');
        };
      });
    }

    // Load users on page load
    loadUsers();
  </script>
</body>

</html>