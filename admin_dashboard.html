<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard - Pasalobong Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin_dashboard.css">
</head>

<body class="no-scroll">
  <header>
    <nav class="navbar">
      <button id="burgerBtn" class="burger" aria-label="Open menu" aria-expanded="false" aria-controls="sideDrawer">
        <span></span><span></span><span></span>
      </button>
      <div class="navbar-left">
        <span class="admin-title">ADMIN DASHBOARD</span>
      </div>
      <div class="navbar-right">
        <div class="notif-wrapper" id="notifWrapper" aria-haspopup="true">
          <button id="notifBtn" class="notif-btn" aria-label="Notifications" aria-expanded="false">ðŸ””
            <span id="notifBadge" class="notif-badge">0</span>
          </button>
          <div id="notifDropdown" class="notif-dropdown" role="menu" aria-hidden="true">
            <div class="notif-header">Notifications</div>
            <div id="notifList" class="notif-list">
              <div id="notifEmpty" class="notif-empty">No new notifications</div>
            </div>
            <div class="notif-footer">
              <a href="orders.html" class="notif-view-all">View orders</a>
            </div>
          </div>
        </div>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>
  <!-- Side Drawer -->
  <aside id="sideDrawer" class="side-drawer" aria-hidden="true">
    <div class="drawer-header">Menu</div>
    <ul class="drawer-list">
      <li><a href="admin_dashboard.html">Admin Dashboard</a></li>
      <li><a href="inventory.html">Product Inventory & Monitoring</a></li>
      <li><a href="users.html">User Accounts Management</a></li>
      <li><a href="orders.html">Order Monitoring</a></li>
    </ul>
  </aside>
  <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>

  <main>
    <section class="dashboard-section">

      <!-- Dashboard Overview Cards -->
      <div class="dashboard-overview">
        <div class="overview-card">
          <div class="card-icon">ðŸ“¦</div>
          <div class="card-content">
            <h3>Total Products</h3>
            <p class="card-number">156</p>
            <span class="card-subtitle">Active products</span>
          </div>
        </div>

        <div class="overview-card">
          <div class="card-icon">ðŸ‘¥</div>
          <div class="card-content">
            <h3>Total Users</h3>
            <p class="card-number">2,341</p>
            <span class="card-subtitle">Registered users</span>
          </div>
        </div>

        <div class="overview-card">
          <div class="card-icon">ðŸ“‹</div>
          <div class="card-content">
            <h3>Total Orders</h3>
            <p class="card-number">89</p>
            <span class="card-subtitle">Pending orders</span>
          </div>
        </div>

        <div class="overview-card">
          <div class="card-icon">ðŸ’°</div>
          <div class="card-content">
            <h3>Total Revenue</h3>
            <p class="card-number">â‚±45,230</p>
            <span class="card-subtitle">This month</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
          <a href="inventory.html" class="action-btn">
            <div class="btn-icon">ðŸ“¦</div>
            <div class="btn-content">
              <h4>Manage Products</h4>
              <p>Add, edit, or view products</p>
            </div>
          </a>

          <a href="users.html" class="action-btn">
            <div class="btn-icon">ðŸ‘¥</div>
            <div class="btn-content">
              <h4>Manage Users</h4>
              <p>View and manage user accounts</p>
            </div>
          </a>

          <a href="orders.html" class="action-btn">
            <div class="btn-icon">ðŸ“‹</div>
            <div class="btn-content">
              <h4>View Orders</h4>
              <p>Monitor and process orders</p>
            </div>
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Logout Modal -->
  <div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to logout?</p>
      <div class="logout-modal-actions">
        <button id="confirmLogoutBtn" class="modal-btn logout-confirm">Logout</button>
        <button id="cancelLogoutBtn" class="modal-btn logout-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // UI Only: Modal logic for logout (no backend)
    const logoutModal = document.getElementById('logoutModal');
    document.getElementById('logoutBtn').onclick = () => {
      logoutModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    };
    document.getElementById('cancelLogoutBtn').onclick = () => {
      logoutModal.classList.remove('open');
      document.body.style.overflow = '';
    };
    logoutModal.onclick = function (e) {
      if (e.target === logoutModal) {
        logoutModal.classList.remove('open');
        document.body.style.overflow = '';
      }
    };
    document.getElementById('confirmLogoutBtn').onclick = () => {
      logoutModal.classList.remove('open');
      document.body.style.overflow = '';
      window.location.href = 'index.html';
    };

    // Burger / Drawer
    const burgerBtn = document.getElementById('burgerBtn');
    const sideDrawer = document.getElementById('sideDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    function openDrawer() {
      sideDrawer.classList.add('open');
      drawerBackdrop.hidden = false;
      document.body.style.overflow = 'hidden';
      burgerBtn.setAttribute('aria-expanded', 'true');
      sideDrawer.setAttribute('aria-hidden', 'false');
    }
    function closeDrawer() {
      sideDrawer.classList.remove('open');
      drawerBackdrop.hidden = true;
      document.body.style.overflow = '';
      burgerBtn.setAttribute('aria-expanded', 'false');
      sideDrawer.setAttribute('aria-hidden', 'true');
    }
    burgerBtn.onclick = openDrawer;
    drawerBackdrop.onclick = closeDrawer;
    sideDrawer.addEventListener('click', (e) => {
      if (e.target.tagName === 'A') closeDrawer();
    });
  </script>
  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { collection, query, where, orderBy, onSnapshot, limit, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const notifBtn = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');
    const notifDropdown = document.getElementById('notifDropdown');
    const notifList = document.getElementById('notifList');
    const notifEmpty = document.getElementById('notifEmpty');

    let unseenCount = 0;
    const pageLoadTime = new Date();
    const maxItems = 10;

    function toggleDropdown(open) {
      const willOpen = typeof open === 'boolean' ? open : !notifDropdown.classList.contains('open');
      notifDropdown.classList.toggle('open', willOpen);
      notifDropdown.setAttribute('aria-hidden', String(!willOpen));
      notifBtn.setAttribute('aria-expanded', String(willOpen));
      if (willOpen) {
        unseenCount = 0;
        notifBadge.style.display = 'none';
      }
    }

    // Mark notification as read
    async function markAsRead(notifId) {
      try {
        const notifRef = doc(db, 'notifications', notifId);
        await updateDoc(notifRef, {
          isRead: true
        });
        console.log('Notification marked as read:', notifId);
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    // Handle notification click - mark as read and navigate
    function handleNotificationClick(notifId, orderId) {
      if (notifId) {
        markAsRead(notifId);
      }
      
      // Navigate to orders page
      if (orderId) {
        window.location.href = `orders.html?orderId=${orderId}`;
      } else {
        window.location.href = 'orders.html';
      }
    }

    function addNotifItem(data) {
      const item = document.createElement('div');
      item.className = 'notif-item';
      
      // Add unread styling if notification is unread
      if (!data.isRead) {
        item.classList.add('notif-unread');
      }

      // Check if it's from notifications collection or orders collection
      const isFromNotifications = data.title && data.message;

      if (isFromNotifications) {
        // Display notification from /notifications collection with products
        let productsHtml = '';
        
        // Check if products array exists and has items
        if (data.products && data.products.length > 0) {
          productsHtml = '<div class="notif-products">';
          data.products.forEach((product, index) => {
            // Show max 3 products to avoid clutter
            if (index < 3) {
              productsHtml += `
                <div class="notif-product-item">
                  â€¢ ${product.name} (x${product.quantity}) - â‚±${product.price.toFixed(2)}
                </div>
              `;
            }
          });
          
          // If there are more than 3 products, show a "more" indicator
          if (data.products.length > 3) {
            productsHtml += `<div class="notif-product-more">+ ${data.products.length - 3} more item(s)</div>`;
          }
          
          productsHtml += '</div>';
        }

        // Add mark as read button if unread
        const markAsReadBtn = !data.isRead ? `
          <button class="mark-read-btn" data-notif-id="${data.id}">Mark as Read</button>
        ` : '';

        item.innerHTML = `
          <div class="notif-icon">ðŸ””</div>
          <div class="notif-content" data-notif-id="${data.id}" data-order-id="${data.orderId || ''}">
            <div class="notif-title">${data.title}</div>
            <div class="notif-sub">${data.message}</div>
            ${productsHtml}
            ${markAsReadBtn}
          </div>
        `;
      } else {
        // Display notification from /orders collection (fallback)
        const orderIdShort = (data.id || '').substring(0, 8);
        const createdAt = data.createdAt?.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Just now';
        const total = typeof data.total === 'number' ? `â‚±${data.total.toFixed(2)}` : 'N/A';

        // Build products list for orders collection fallback
        let productsHtml = '';
        if (data.items && data.items.length > 0) {
          productsHtml = '<div class="notif-products">';
          data.items.forEach((product, index) => {
            if (index < 3) {
              productsHtml += `
                <div class="notif-product-item">
                  â€¢ ${product.name} (x${product.quantity}) - â‚±${product.price.toFixed(2)}
                </div>
              `;
            }
          });
          if (data.items.length > 3) {
            productsHtml += `<div class="notif-product-more">+ ${data.items.length - 3} more item(s)</div>`;
          }
          productsHtml += '</div>';
        }

        item.innerHTML = `
          <div class="notif-icon">ðŸ›’</div>
          <div class="notif-content" data-order-id="${data.id}">
            <div class="notif-title">New order received â€¢ ${total}</div>
            <div class="notif-sub">#${orderIdShort} â€¢ ${createdAt}</div>
            ${productsHtml}
          </div>
        `;
      }

      if (notifEmpty) notifEmpty.style.display = 'none';
      notifList.insertBefore(item, notifList.firstChild);

      // Trim list
      while (notifList.children.length > maxItems + 1) {
        const last = notifList.lastElementChild;
        if (last && last.id !== 'notifEmpty') notifList.removeChild(last);
        else break;
      }

      unseenCount += 1;
      notifBadge.textContent = String(unseenCount);
      notifBadge.style.display = unseenCount > 0 ? 'inline-block' : 'none';
    }

    // Toggle dropdown
    notifBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDropdown();
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      const within = document.getElementById('notifWrapper')?.contains(e.target);
      if (!within) toggleDropdown(false);
    });

    // Event delegation for notification clicks and mark as read buttons
    notifList.addEventListener('click', (e) => {
      // Handle "Mark as Read" button click
      if (e.target.classList.contains('mark-read-btn')) {
        e.stopPropagation();
        const notifId = e.target.dataset.notifId;
        if (notifId) {
          markAsRead(notifId);
          // Remove the button and unread styling
          e.target.remove();
          const notifItem = e.target.closest('.notif-item');
          if (notifItem) {
            notifItem.classList.remove('notif-unread');
          }
        }
        return;
      }

      // Handle notification content click
      const notifContent = e.target.closest('.notif-content');
      if (notifContent) {
        const notifId = notifContent.dataset.notifId;
        const orderId = notifContent.dataset.orderId;
        handleNotificationClick(notifId, orderId);
      }
    });

    // ========================================================================
    // DUAL NOTIFICATION SYSTEM: Listen to both orders AND notifications collections
    // ========================================================================
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      try {
        // METHOD 1: Listen to /notifications collection
        const notificationsRef = collection(db, 'notifications');
        const qNotifications = query(
          notificationsRef,
          where('recipientId', 'in', [user.uid, 'all_admins']),
          orderBy('createdAt', 'desc'),
          limit(20)
        );

        onSnapshot(qNotifications, 
          (snapshot) => {
            console.log('Notifications snapshot received:', snapshot.size, 'docs');
            snapshot.docChanges().forEach((change) => {
              if (change.type === 'added') {
                const data = { id: change.doc.id, ...change.doc.data() };
                console.log('New notification detected:', data);
                const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();

                // Show unread notifications OR notifications created after page load
                if (!data.isRead || createdAt >= pageLoadTime) {
                  console.log('Adding notification to UI');
                  addNotifItem(data);
                }
              }
            });
          },
          (error) => {
            console.error('Notification query error:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
          }
        );

        // METHOD 2: Listen to /orders collection directly (for new pending orders)
        const ordersRef = collection(db, 'orders');
        const qOrders = query(ordersRef, orderBy('createdAt', 'desc'), limit(50));

        onSnapshot(qOrders, 
          (snapshot) => {
            console.log('Orders snapshot received:', snapshot.size, 'docs');
            snapshot.docChanges().forEach((change) => {
              if (change.type === 'added') {
                const data = { id: change.doc.id, ...change.doc.data() };
                const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : (data.createdAt?.seconds ? new Date(data.createdAt.seconds * 1000) : new Date());

                // Only show new pending orders created after page load
                if (data.status === 'pending' && createdAt >= pageLoadTime) {
                  console.log('Adding new order notification:', data.id);
                  addNotifItem(data);
                }
              }
            });
          },
          (error) => {
            console.error('Orders query error:', error);
          }
        );

        console.log('Admin notification listeners active');
      } catch (e) {
        console.error('Notifications setup error:', e);
      }
    });
  </script>
  </script>
</body>

</html>