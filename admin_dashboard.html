<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard - Pasalobong Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin_dashboard.css">
</head>
<body class="no-scroll">
  <header>
    <nav class="navbar">
      <button id="burgerBtn" class="burger" aria-label="Open menu" aria-expanded="false" aria-controls="sideDrawer">
        <span></span><span></span><span></span>
      </button>
      <div class="navbar-left">
        <span class="admin-title">ADMIN DASHBOARD</span>
      </div>
      <div class="navbar-right">
        <div class="notif-wrapper" id="notifWrapper" aria-haspopup="true">
          <button id="notifBtn" class="notif-btn" aria-label="Notifications" aria-expanded="false">ðŸ””
            <span id="notifBadge" class="notif-badge">0</span>
          </button>
          <div id="notifDropdown" class="notif-dropdown" role="menu" aria-hidden="true">
            <div class="notif-header">Notifications</div>
            <div id="notifList" class="notif-list">
              <div id="notifEmpty" class="notif-empty">No new notifications</div>
            </div>
            <div class="notif-footer">
              <a href="orders.html" class="notif-view-all">View orders</a>
            </div>
          </div>
        </div>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>
  <!-- Side Drawer -->
  <aside id="sideDrawer" class="side-drawer" aria-hidden="true">
    <div class="drawer-header">Menu</div>
    <ul class="drawer-list">
      <li><a href="admin_dashboard.html">Admin Dashboard</a></li>
      <li><a href="inventory.html">Product Inventory & Monitoring</a></li>
      <li><a href="users.html">User Accounts Management</a></li>
      <li><a href="orders.html">Order Monitoring</a></li>
    </ul>
  </aside>
  <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>
  
  <main>
    <section class="dashboard-section">
      
      <!-- Dashboard Overview Cards -->
      <div class="dashboard-overview">
        <div class="overview-card">
          <div class="card-icon">ðŸ“¦</div>
          <div class="card-content">
            <h3>Total Products</h3>
            <p class="card-number">156</p>
            <span class="card-subtitle">Active products</span>
          </div>
        </div>
        
        <div class="overview-card">
          <div class="card-icon">ðŸ‘¥</div>
          <div class="card-content">
            <h3>Total Users</h3>
            <p class="card-number">2,341</p>
            <span class="card-subtitle">Registered users</span>
          </div>
        </div>
        
        <div class="overview-card">
          <div class="card-icon">ðŸ“‹</div>
          <div class="card-content">
            <h3>Total Orders</h3>
            <p class="card-number">89</p>
            <span class="card-subtitle">Pending orders</span>
          </div>
        </div>
        
        <div class="overview-card">
          <div class="card-icon">ðŸ’°</div>
          <div class="card-content">
            <h3>Total Revenue</h3>
            <p class="card-number">â‚±45,230</p>
            <span class="card-subtitle">This month</span>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
          <a href="inventory.html" class="action-btn">
            <div class="btn-icon">ðŸ“¦</div>
            <div class="btn-content">
              <h4>Manage Products</h4>
              <p>Add, edit, or view products</p>
            </div>
          </a>
          
          <a href="users.html" class="action-btn">
            <div class="btn-icon">ðŸ‘¥</div>
            <div class="btn-content">
              <h4>Manage Users</h4>
              <p>View and manage user accounts</p>
            </div>
          </a>
          
          <a href="orders.html" class="action-btn">
            <div class="btn-icon">ðŸ“‹</div>
            <div class="btn-content">
              <h4>View Orders</h4>
              <p>Monitor and process orders</p>
            </div>
          </a>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Logout Modal -->
  <div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to logout?</p>
      <div class="logout-modal-actions">
        <button id="confirmLogoutBtn" class="modal-btn logout-confirm">Logout</button>
        <button id="cancelLogoutBtn" class="modal-btn logout-cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <script>
    // UI Only: Modal logic for logout (no backend)
    const logoutModal = document.getElementById('logoutModal');
    document.getElementById('logoutBtn').onclick = () => {
      logoutModal.classList.add('open');
      document.body.style.overflow = 'hidden';
    };
    document.getElementById('cancelLogoutBtn').onclick = () => {
      logoutModal.classList.remove('open');
      document.body.style.overflow = '';
    };
    logoutModal.onclick = function(e) {
      if (e.target === logoutModal) {
        logoutModal.classList.remove('open');
        document.body.style.overflow = '';
      }
    };
    document.getElementById('confirmLogoutBtn').onclick = () => {
      logoutModal.classList.remove('open');
      document.body.style.overflow = '';
      window.location.href = 'index.html';
    };

    // Burger / Drawer
    const burgerBtn = document.getElementById('burgerBtn');
    const sideDrawer = document.getElementById('sideDrawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    function openDrawer() {
      sideDrawer.classList.add('open');
      drawerBackdrop.hidden = false;
      document.body.style.overflow = 'hidden';
      burgerBtn.setAttribute('aria-expanded', 'true');
      sideDrawer.setAttribute('aria-hidden', 'false');
    }
    function closeDrawer() {
      sideDrawer.classList.remove('open');
      drawerBackdrop.hidden = true;
      document.body.style.overflow = '';
      burgerBtn.setAttribute('aria-expanded', 'false');
      sideDrawer.setAttribute('aria-hidden', 'true');
    }
    burgerBtn.onclick = openDrawer;
    drawerBackdrop.onclick = closeDrawer;
    sideDrawer.addEventListener('click', (e) => {
      if (e.target.tagName === 'A') closeDrawer();
    });
  </script>
  <script type="module">
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { collection, query, orderBy, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const notifBtn = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');
    const notifDropdown = document.getElementById('notifDropdown');
    const notifList = document.getElementById('notifList');
    const notifEmpty = document.getElementById('notifEmpty');

    let unseenCount = 0;
    const pageLoadSeconds = Math.floor(Date.now() / 1000);
    const maxItems = 10;

    function toggleDropdown(open) {
      const willOpen = typeof open === 'boolean' ? open : !notifDropdown.classList.contains('open');
      notifDropdown.classList.toggle('open', willOpen);
      notifDropdown.setAttribute('aria-hidden', String(!willOpen));
      notifBtn.setAttribute('aria-expanded', String(willOpen));
      if (willOpen) {
        unseenCount = 0;
        notifBadge.style.display = 'none';
      }
    }

    function addNotifItem(order) {
      const item = document.createElement('div');
      item.className = 'notif-item';
      const orderIdShort = (order.id || '').substring(0, 8);
      const createdAt = order.createdAt?.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleString() : 'Just now';
      const total = typeof order.total === 'number' ? `â‚±${order.total.toFixed(2)}` : 'N/A';

      item.innerHTML = `
        <div class="notif-icon">ðŸ›’</div>
        <div class="notif-content">
          <div class="notif-title">New order received â€¢ ${total}</div>
          <div class="notif-sub">#${orderIdShort} â€¢ ${createdAt}</div>
        </div>
      `;

      if (notifEmpty) notifEmpty.style.display = 'none';
      notifList.insertBefore(item, notifList.firstChild);

      // Trim list
      while (notifList.children.length > maxItems + 1) { // +1 accounts for empty div possibly
        const last = notifList.lastElementChild;
        if (last && last.id !== 'notifEmpty') notifList.removeChild(last);
        else break;
      }

      unseenCount += 1;
      notifBadge.textContent = String(unseenCount);
      notifBadge.style.display = unseenCount > 0 ? 'inline-block' : 'none';
    }

    // Toggle dropdown
    notifBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDropdown();
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      const within = document.getElementById('notifWrapper')?.contains(e.target);
      if (!within) toggleDropdown(false);
    });

    // Auth gate (admin only) and realtime listener for new orders
    onAuthStateChanged(auth, async (user) => {
      if (!user) return; // silently ignore on dashboard UI
      try {
        // Lightweight: listen without role fetch; orders.html already enforces admin for management
        const ordersRef = collection(db, 'orders');
        const q = query(ordersRef, orderBy('createdAt', 'desc'), limit(50));
        onSnapshot(q, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
              const data = { id: change.doc.id, ...change.doc.data() };
              const createdSec = data.createdAt?.seconds || 0;
              if (data.status === 'pending' && createdSec >= pageLoadSeconds) {
                addNotifItem(data);
              }
            }
          });
        });
      } catch (e) {
        // Fail silently; dashboard still usable
        console.error('Notifications error:', e);
      }
    });
  </script>
</body>
</html>